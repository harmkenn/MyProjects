---
title: "Predicting March Madness"
author: "Ken Harmon"
date: "`r format(Sys.time(), '%Y %B %d')`"
output:
  html_document:  
    keep_md: true
    code_folding: hide
    fig_height: 6
    fig_width: 12
    fig_align: 'center'
editor_options: 
  chunk_output_type: console
---

# {.tabset .tabset-fade}

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(ggplot2)
library(tidyverse)
library(mosaic)
library(PerformanceAnalytics)
library(stringr)
library(psych) 
```

## Background

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
all_Games <- as_tibble(read.csv("withRanking.csv"))
SeasonStats <- as_tibble(read.csv("NCAASeasonTeamStats.csv"))
```

```{r Cds}
fss <- SeasonStats %>% mutate(Year = as.integer(str_extract(Season, "^.{4}")) + 1) %>% setNames(paste0("F.",names(.)))
uss <- SeasonStats %>% mutate(Year = as.integer(str_extract(Season, "^.{4}")) + 1) %>% setNames(paste0("U.",names(.)))

JoinedFavoredStats <- left_join(all_Games,fss,by = c("Year" = "F.Year","F.Team" = "F.Team"))

JoinedUnderdogStats <- left_join(JoinedFavoredStats,uss,by = c("Year" = "U.Year","U.Team" = "U.Team"))

fs <- JoinedUnderdogStats %>% select(starts_with("F.")) %>% select(1:3,5,8:38)
us <- JoinedUnderdogStats %>% select(contains("U.")) %>% select(1:3,5,8:38)
dfu <- fs - us
dfu <- dfu %>% rename_all(funs(str_replace(., "F.", "D."))) %>% tibble::rowid_to_column("ID")
AGwDS <- left_join(all_Games,dfu,by = c("ID" = "ID"))
```

```{r correlation}
bestfit <- AGwDS %>% select(starts_with("D.")) %>% select(4,9,19)
bestfit$split <- rnorm(nrow(bestfit)) > -1.4
buildfit <- bestfit %>% filter(split)
chart.Correlation(buildfit,histogram=TRUE, pch=19)
```

```{r lm}
mmlm <- lm(D.Score~D.SRS+D.MP, buildfit)
summary(mmlm)
```

```{r predict}
testfit <- bestfit %>% filter(!split)
testfit$pred <- predict(mmlm, testfit)
testfit$result <- sign(testfit$D.Score)==sign(testfit$pred)
table(testfit$result)
```

