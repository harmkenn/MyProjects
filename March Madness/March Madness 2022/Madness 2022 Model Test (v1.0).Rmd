---
title: "Madness 2022 Model Test"
author: "Ken Harmon"
date: "`r format(Sys.time(), '%Y %B %d')`"
output:
  html_document:  
    keep_md: true
    code_folding: hide
    fig_height: 6
    fig_width: 12
    fig_align: 'center'
editor_options: 
  chunk_output_type: console
---

# {.tabset .tabset-fade}

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load_libraries, include=FALSE}
# Use this R-Chunk to load all your libraries!
pacman::p_load(tidyverse, gt, DT, data.table)
```

```{r swd, eval=FALSE, echo=FALSE}
# this is set to not run during the knit process
# this sets the working directory to the file location
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

## Seed History

```{r}
#Load in Historical Games from 1985 through 2022
AllGames <- read.csv("All Games.csv")
AllGames <- AllGames %>% filter(Round != "PI")
#Build Seed History
seed.history <- data.frame(rbind(table(AllGames$Winning.Seed,AllGames$Round)))%>%select(2:7)
seed.history$exp <- rowSums(seed.history)/144
gt(seed.history,,,TRUE)%>% 
   data_color(
    columns = 2:8, 
    colors = scales::col_numeric(
      palette = c("white","blue") %>% as.character(),
      domain = NULL
    )
  ) 
```

## Team Wins

```{r}
losers <- data.frame(rbind(table(AllGames$Loser,AllGames$Year)))
losers <- losers %>% add_rownames()
winners <- data.frame(rbind(table(AllGames$Winner,AllGames$Year)))
winners[winners > 0] <- winners[winners > 0] + 1
winners <- winners %>% add_rownames()



b2b <- left_join(losers,winners,by=c("rowname"="rowname"))
b2b[is.na(b2b)] <- 0
team.history <- cbind(b2b$rowname,b2b[,2:37]+b2b[,38:73])
colnames(team.history) <- c("team",seq(1985,2019,1),2021)
rownames(team.history) <- team.history$team
team.history <- team.history[-1,-1]
scale.v <- seq(.5,1,.5/35)
team.history$Exp <- colSums(t(team.history) * scale.v)
team.history[,1:36] <- team.history[,1:36] - 1
team.history[team.history == -1] <- NA
datatable(team.history)
```

## Team Seeds

```{r}
team.seed.w <- AllGames %>% filter(Round == 1) %>% select(c(2,5,6))
colnames(team.seed.w) <- c("Year","Seed","Team")
team.seed.l <- AllGames %>% filter(Round == 1) %>% select(c(2,9,10))
colnames(team.seed.l) <- c("Year","Seed","Team")
team.seed.long <- rbind(team.seed.w,team.seed.l)
team.seed.wide <- spread(team.seed.long, Year, Seed)
datatable(team.seed.wide)
```

## PASE

```{r}
x <- team.seed.wide
old <- 1:16
new <- seed.history$exp
for (i in old) {
x[x == i] <- new[i]
}

#setdiff(x$Team,rownames(team.history))

team.exp.wide <- x 
team.pase.wide <- cbind(team.history[,1:36]-x[,2:37])
team.pase <- data.frame(cbind(rowMeans(team.pase.wide, na.rm=TRUE)))
colnames(team.pase) <- "Pase"
datatable(team.pase)
```

